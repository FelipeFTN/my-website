name: Rust Web

on:
  push:
    branches:
      - master

jobs:
  dioxus-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        toolchain: ["stable"]
        buildMode: ["release"]
        outDirectory: ["dist"]

    steps:
      - uses: actions/checkout@v4
      - name: "Checkout Repository"
        run: |
          mv ./web/* ./
          rm -rf ./web

      - name: "Set up Rust"
        shell: bash
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup toolchain install ${{ matrix.toolchain }}
          rustup target add wasm32-unknown-unknown

      - name: "Build Dioxus Project 🎁"
        shell: bash
        run: |
          source $HOME/.cargo/env
          curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
          cargo binstall dioxus-cli -y
          dx build --${{ matrix.buildMode }}
          cp -r config/ ./${{ matrix.outDirectory }}/
          cp -r ./target/dx/my-website/release/web/public/* ${{ matrix.outDirectory }}/ 2>/dev/null

      - name: "Cache Rust dependencies"
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: "true"
          cache-all-crates: "true"

      - name: "Deploy Project 🚀"
        uses: JamesIves/github-pages-deploy-action@v4.4.1
        with:
          branch: github-pages
          folder: ${{ matrix.outDirectory }}
          clean: true
